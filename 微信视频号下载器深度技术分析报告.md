# å¾®ä¿¡è§†é¢‘å·ä¸‹è½½å™¨æ·±åº¦æŠ€æœ¯åˆ†ææŠ¥å‘Š

## ğŸ“‹ æŠ¥å‘Šæ¦‚è§ˆ

æœ¬æŠ¥å‘ŠåŸºäºå¯¹ `wx_channels_download` é¡¹ç›®çš„æ·±åº¦æŠ€æœ¯åˆ†æï¼Œå…¨é¢è§£æäº†å¾®ä¿¡è§†é¢‘å·ä¸‹è½½å™¨çš„è¿è¡Œæœºåˆ¶ã€æ•°æ®æµæˆªè·åŸç†ã€è§£å¯†ç®—æ³•å®ç°ä»¥åŠé€†å‘å·¥ç¨‹æŠ€æœ¯è·¯çº¿ã€‚

**é¡¹ç›®ä¿¡æ¯ï¼š**
- **é¡¹ç›®åç§°ï¼š** å¾®ä¿¡è§†é¢‘å·ä¸‹è½½å™¨
- **æŠ€æœ¯æ ˆï¼š** Goè¯­è¨€ + JavaScriptæ³¨å…¥ + HTTPä»£ç†
- **æ”¯æŒå¹³å°ï¼š** macOSã€Windows
- **æ ¸å¿ƒåŠŸèƒ½ï¼š** è§†é¢‘å·è§†é¢‘ä¸‹è½½ã€è§£å¯†ã€å¤šæ ¼å¼å¯¼å‡º

---

## ğŸ—ï¸ é¡¹ç›®æ¶æ„åˆ†æ

### æŠ€æœ¯æ¶æ„æ¦‚è§ˆ
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   ç”¨æˆ·æµè§ˆå™¨    â”‚ â†’  â”‚   ç³»ç»Ÿçº§ä»£ç†     â”‚ â†’  â”‚   ä»£ç†æœåŠ¡å™¨     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                  â†“
                          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                          â”‚ JavaScriptæ³¨å…¥   â”‚
                          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                  â†“
                          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                          â”‚   æ•°æ®æˆªè·       â”‚
                          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                  â†“
                          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                          â”‚   è§£å¯†ä¸‹è½½       â”‚
                          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### æ ¸å¿ƒç»„ä»¶ç»“æ„

#### 1. ä»£ç†æ‹¦æˆªå±‚ (`internal/interceptor/`)
- **`interceptor.go`**: ä»£ç†æœåŠ¡å™¨æ ¸å¿ƒé€»è¾‘
- **`plugin.go`**: JavaScriptæ³¨å…¥å’ŒHTTPå“åº”å¤„ç†
- **`server.go`**: è¯ä¹¦ç®¡ç†å’Œä»£ç†æœåŠ¡

#### 2. ä¸‹è½½æœåŠ¡å±‚ (`internal/download/`)
- **`download.go`**: å¤šçº¿ç¨‹ä¸‹è½½å’Œè§£å¯†å®ç°
- **`server.go`**: æœ¬åœ°ä¸‹è½½æœåŠ¡å™¨

#### 3. JavaScriptæ³¨å…¥å±‚ (`inject/`)
- **`main.js`**: æ ¸å¿ƒä¸‹è½½é€»è¾‘å’ŒUIæ³¨å…¥
- **`utils.js`**: å·¥å…·å‡½æ•°åº“
- **`live.js`**: ç›´æ’­ä¸‹è½½æ”¯æŒ

#### 4. è§£å¯†ç®—æ³•å±‚ (`pkg/decrypt/`)
- **`decrypt.go`**: ISAAC-64åŠ å¯†ç®—æ³•å®ç°

---

## ğŸ” æ•°æ®æµæˆªè·æœºåˆ¶æ·±åº¦è§£æ

### 1. HTTPä»£ç†æ‹¦æˆªåŸç†

#### ä»£ç†æœåŠ¡å™¨å¯åŠ¨æµç¨‹
```go
// ä»£ç ä½ç½®: cmd/root.go:106-111
interceptorServer, err := interceptor.NewInterceptorServer(args.InterceptorConfig)
if err != nil {
    fmt.Printf("ERROR åˆå§‹åŒ–ä»£ç†æœåŠ¡å¤±è´¥: %v\n", err.Error())
    os.Exit(1)
}
mgr.RegisterServer(interceptorServer)
```

#### å…³é”®æŠ€æœ¯ç‚¹
1. **è‡ªç­¾åè¯ä¹¦ç®¡ç†**: è‡ªåŠ¨å®‰è£…"SunnyNet"æ ¹è¯ä¹¦åˆ°ç³»ç»Ÿä¿¡ä»»åº“
2. **HTTPSæµé‡è§£å¯†**: é€šè¿‡MITM (Man-In-The-Middle) æ–¹å¼è§£å¯†HTTPSæµé‡
3. **åŸŸåç²¾å‡†åŒ¹é…**: ä»…æ‹¦æˆª `channels.weixin.qq.com` åŸŸåç›¸å…³è¯·æ±‚

### 2. JavaScriptæ³¨å…¥æœºåˆ¶

#### HTMLé¡µé¢æ³¨å…¥ (`plugin.go:139-188`)
```javascript
// æ³¨å…¥æµç¨‹åˆ†æ
if pathname == "/web/pages/feed" || pathname == "/web/pages/home" {
    /** ä¸‹è½½é€»è¾‘ */
    script_main := fmt.Sprintf(`<script>%s</script>`, files.JSMain)
    inserted_scripts += script_main
    html = strings.Replace(html, "<head>", "<head>\n"+inserted_scripts, 1)
}
```

#### æ ¸å¿ƒè„šæœ¬æ–‡ä»¶
- **`utils.js`**: å…¨å±€å·¥å…·å‡½æ•°å’Œé…ç½®
- **`main.js`**: è§†é¢‘ä¸‹è½½å’ŒUIäº¤äº’é€»è¾‘
- **`pagespy.min.js`**: åœ¨çº¿è°ƒè¯•å·¥å…·ï¼ˆå¯é€‰ï¼‰

### 3. å…³é”®å‡½æ•°åŠ«æŒæŠ€æœ¯

#### 3.1 sourceBuffer.appendBuffer æ•°æ®æˆªè·

**åŸå§‹ä»£ç æ¨¡å¼ï¼š**
```javascript
// å¾®ä¿¡åŸå§‹JavaScript
this.sourceBuffer.appendBuffer(data)
```

**åŠ«æŒåä»£ç ï¼š**
```javascript
// ä»£ç ä½ç½®: plugin.go:208-216
(() => {
    if (window.__wx_channels_store__) {
        window.__wx_channels_store__.buffers.push($1);
    }
})(),this.sourceBuffer.appendBuffer($1),
```

**æŠ€æœ¯åŸç†ï¼š**
- åœ¨ `appendBuffer` è°ƒç”¨å‰æ’å…¥æ•°æ®ç¼“å­˜é€»è¾‘
- ä½¿ç”¨é—­åŒ…ç¡®ä¿åŸæœ‰åŠŸèƒ½ä¸å—å½±å“
- é€šè¿‡å…¨å±€å˜é‡ `__wx_channels_store__.buffers` å­˜å‚¨æ•°æ®å—

#### 3.2 AUTO_CUT äº‹ä»¶å¯†é’¥æˆªè·

**äº‹ä»¶åŠ«æŒé€»è¾‘ï¼š**
```javascript
// ä»£ç ä½ç½®: plugin.go:217-224
if(f.cmd==="CUT"){
    if (window.__wx_channels_store__ && __wx_channels_store__.profile) {
        console.log("CUT", f, __wx_channels_store__.profile.key);
        window.__wx_channels_store__.keys[__wx_channels_store__.profile.key]=f.decryptor_array;
    }
}
if(f.cmd===re.MAIN_THREAD_CMD.AUTO_CUT) {
    // åŸå§‹å¤„ç†é€»è¾‘
}
```

**å¯†é’¥æå–æœºåˆ¶ï¼š**
1. **æ—¶åºåˆ©ç”¨**: åœ¨è§†é¢‘ç‰‡æ®µåˆ‡æ¢æ—¶è·å–å¯†é’¥
2. **äº‹ä»¶ç›‘å¬**: ç›‘æ§ `AUTO_CUT` å’Œ `CUT` äº‹ä»¶
3. **å¯†é’¥å­˜å‚¨**: å°†è§£å¯†å¯†é’¥æ•°ç»„å­˜å‚¨åˆ°å…¨å±€æ˜ å°„è¡¨

#### 3.3 finderGetCommentDetail å‡½æ•°æ”¹å†™

**å‡½æ•°ç»“æ„é‡å†™ï¼š**
```javascript
// ä»£ç ä½ç½®: plugin.go:276-321
async finderGetCommentDetail($1) {
    var feedResult = await (async () => {
        $2;  // ä¿æŒåŸæœ‰é€»è¾‘
    })();

    // æ–°å¢è§†é¢‘ä¿¡æ¯æå–
    var profile = {
        type: "media",
        title: data_object.objectDesc.description,
        url: media.url+media.urlToken,        // è§†é¢‘ä¸‹è½½é“¾æ¥
        key: media.decodeKey,                 // è§£å¯†å¯†é’¥
        spec: media.spec,                     // è§†é¢‘è§„æ ¼é€‰é¡¹
        // ... å…¶ä»–å…ƒæ•°æ®
    };

    // å­˜å‚¨åˆ°å…¨å±€å˜é‡
    window.__wx_channels_store__.profile = profile;

    return feedResult;
}
```

---

## ğŸ” è§£å¯†ç®—æ³•æ·±åº¦åˆ†æ

### 1. ISAAC-64åŠ å¯†ç®—æ³•å®ç°

#### ç®—æ³•ç‰¹å¾
```go
// ä»£ç ä½ç½®: pkg/decrypt/decrypt.go:18-27
type RandCtx64 struct {
    RandCnt uint64
    Seed    [256]uint64    // ISAACçŠ¶æ€æ•°ç»„
    MM      [256]uint64    // å†…éƒ¨çŠ¶æ€
    AA      uint64        // ç´¯åŠ å™¨A
    BB      uint64        // ç´¯åŠ å™¨B
    CC      uint64        // ç´¯åŠ å™¨C
}
```

#### å¯†é’¥ç”Ÿæˆæµç¨‹
```go
// ä»£ç ä½ç½®: pkg/decrypt/decrypt.go:40-95
func rand64Init(ctx *RandCtx64, encKey uint64) {
    // 1. ä½¿ç”¨Golden Ratioå¸¸æ•°åˆå§‹åŒ–
    const golden = uint64(0x9e3779b97f4a7c13)

    // 2. è®¾ç½®ç§å­å¯†é’¥
    ctx.Seed[0] = encKey

    // 3. å››è½®åˆå§‹åŒ–æ··åˆ
    for i := 0; i < 4; i++ {
        mix(&a, &b, &c, &d, &e, &f, &g, &h)
    }

    // 4. çŠ¶æ€æ•°ç»„å¡«å……
    for i := 0; i < 256; i += 8 {
        // å¡«å……MMæ•°ç»„
        mix(&a, &b, &c, &d, &e, &f, &g, &h)
        ctx.MM[i] = a
        // ... å¡«å……8ä¸ªå€¼
    }

    // 5. æ‰§è¡ŒISAACåˆå§‹åŒ–
    ctx.isAAC64()
}
```

### 2. è§£å¯†è¿‡ç¨‹å®ç°

#### JavaScriptå‰ç«¯è§£å¯†
```javascript
// ä»£ç ä½ç½®: inject/main.js:1-9
function __wx_channels_video_decrypt(t, e, p) {
  for (
    var r = new Uint8Array(t), n = 0;
    n < t.byteLength && e + n < p.decryptor_array.length;
    n++
  )
    r[n] ^= p.decryptor_array[n];
  return r;
}
```

#### Goåç«¯è§£å¯†
```go
// ä»£ç ä½ç½®: pkg/decrypt/decrypt.go:149-170
func DecryptData(data []byte, encLen uint32, key uint64) {
    aaInst := CreateISAacInst(key)

    for i := uint32(0); i < encLen; i += 8 {
        randNumber := aaInst.ISAacRandom()
        tempNumber := make([]byte, 8)
        binary.BigEndian.PutUint64(tempNumber, randNumber)

        for j := 0; j < 8; j++ {
            realIndex := i + uint32(j)
            if realIndex >= encLen {
                return
            }
            data[realIndex] ^= tempNumber[j]
        }
    }
}
```

### 3. WASMæ¨¡å—è°ƒç”¨æœºåˆ¶

#### WASMè§£å¯†å™¨åˆå§‹åŒ–
```javascript
// ä»£ç ä½ç½®: inject/main.js:26-42
async function __wx_channels_decrypt(seed) {
    if (!loaded) {
        // åŠ¨æ€åŠ è½½å¾®ä¿¡å®˜æ–¹WASMæ¨¡å—
        await __wx_load_script(
            "https://res.wx.qq.com/t/wx_fed/cdn_libs/res/decrypt-video-core/1.3.0/wasm_video_decode.js"
        );
        loaded = true;
    }

    await sleep();
    decryptor = new Module.WxIsaac64(seed);
    decryptor.generate(131072);  // ç”Ÿæˆ128KBå¯†é’¥æµ

    return decryptor_array;
}
```

#### å¯†é’¥æµç”Ÿæˆæ¥å£
```javascript
// WASMæ¥å£è°ƒç”¨
function wasm_isaac_generate(t, e) {
    decryptor_array = new Uint8Array(e);
    var r = new Uint8Array(Module.HEAPU8.buffer, t, e);
    decryptor_array.set(r.reverse());
}
```

---

## ğŸ’¾ æ•°æ®å­˜å‚¨æ¶æ„åˆ†æ

### 1. å…¨å±€å­˜å‚¨å¯¹è±¡è®¾è®¡

```javascript
window.__wx_channels_store__ = {
    // è§†é¢‘æ•°æ®ç¼“å†²åŒº
    buffers: [Uint8Array, Uint8Array, ...],

    // å½“å‰æ’­æ”¾è§†é¢‘ä¿¡æ¯
    profile: {
        type: "media",
        title: "è§†é¢‘æ ‡é¢˜",
        url: "https://...",
        key: "1234567890",              // ISAACç§å­å¯†é’¥
        decryptor_array: Uint8Array,    // è§£å¯†å¯†é’¥æµ
        spec: [/* è§†é¢‘è§„æ ¼æ•°ç»„ */],
        size: 12345678,                 // æ–‡ä»¶å¤§å°
        duration: 60000,                // æ—¶é•¿(æ¯«ç§’)
        // ... å…¶ä»–å…ƒæ•°æ®
    },

    // è§£å¯†å¯†é’¥æ˜ å°„è¡¨
    keys: {
        "1234567890": Uint8Array(131072),  // è§†é¢‘1çš„å¯†é’¥æµ
        "0987654321": Uint8Array(131072),  // è§†é¢‘2çš„å¯†é’¥æµ
    },

    // å†å²è§†é¢‘ä¿¡æ¯
    profiles: [profile1, profile2, ...]
}
```

### 2. è§†é¢‘ä¿¡æ¯æ•°æ®ç»“æ„

#### ChannelMediaProfile ç»“æ„å®šä¹‰
```go
// ä»£ç ä½ç½®: internal/interceptor/interceptor.go:49-60
type ChannelMediaProfile struct {
    Title    string             `json:"title"`
    CoverURL string             `json:"cover_url"`
    URL      string             `json:"url"`
    Size     int                `json:"size"`
    Key      string             `json:"key"`
    NonceId  string             `json:"nonce_id"`
    Nickname string             `json:"nickname"`
    Type     string             `json:"type"`
    Contact  ChannelContact     `json:"contact"`
    Spec     []ChannelMediaSpec `json:"spec"`
}
```

#### è§†é¢‘è§„æ ¼é€‰é¡¹
```go
// ä»£ç ä½ç½®: internal/interceptor/interceptor.go:27-43
type ChannelMediaSpec struct {
    FileFormat       string  `json:"file_format"`       // å¦‚: xWT111, xWT98
    FirstLoadBytes   int     `json:"first_load_bytes"`
    BitRate          int     `json:"bit_rate"`          // æ¯”ç‰¹ç‡
    CodingFormat     string  `json:"coding_format"`     // ç¼–ç æ ¼å¼
    Vfps             int     `json:"vfps"`              // å¸§ç‡
    Width            int     `json:"width"`             // å®½åº¦
    Height           int     `json:"height"`            // é«˜åº¦
    DurationMs       int     `json:"duration_ms"`       // æ—¶é•¿
    QualityScore     float64 `json:"quality_score"`     // è´¨é‡è¯„åˆ†
    VideoBitrate     int     `json:"video_bitrate"`     // è§†é¢‘æ¯”ç‰¹ç‡
    AudioBitrate     int     `json:"audio_bitrate"`     // éŸ³é¢‘æ¯”ç‰¹ç‡
    LevelOrder       int     `json:"level_order"`       // è´¨é‡ç­‰çº§æ’åº
}
```

---

## ğŸ¯ ä¸‹è½½åŠŸèƒ½å®ç°åˆ†æ

### 1. UIæŒ‰é’®æ³¨å…¥æœºåˆ¶

#### ä¸‹è½½æŒ‰é’®åŠ¨æ€åˆ›å»º
```javascript
// ä»£ç ä½ç½®: inject/main.js:354-386
buttons = [
    {"åŸå§‹è§†é¢‘", "__wx_channels_handle_click_download__"},
    {"å½“å‰è§†é¢‘", "__wx_channels_download_cur__"},
    {"ä¸‹è½½ä¸ºmp3", "() => __wx_channels_handle_click_download__(null, true)"},
    {"æ‰“å°ä¸‹è½½å‘½ä»¤", "__wx_channels_handle_print_download_command"},
    {"ä¸‹è½½å°é¢", "__wx_channels_handle_download_cover"},
    {"å¤åˆ¶é¡µé¢é“¾æ¥", "__wx_channels_handle_copy__"}
];

button_html = buttons.map(btn =>
    `f("div",{class:"context-item",role:"button",onClick:${btn.handler}},"${btn.label}")`
).join(',');

// æ³¨å…¥åˆ°å¾®ä¿¡åŸæœ‰æŒ‰é’®åˆ—è¡¨ä¸­
replace_str = `,"æŠ•è¯‰"),${button_html}]`;
```

#### æŒ‰é’®å®šä½ç­–ç•¥
```javascript
// å¤šç§å®šä½æ–¹å¼ç¡®ä¿å…¼å®¹æ€§
async function __insert_download_btn_to_home_page() {
    var $elm2 = await __wx_find_elm(() =>
        document.getElementsByClassName("full-opr-wrp layout-col")[0]
    );
    if ($elm2) {
        // å‚ç›´å¸ƒå±€æ’å…¥
        var relative_node = $elm2.children[$elm2.children.length - 1];
        $elm2.insertBefore(__wx_channels_video_download_btn__, relative_node);
        return;
    }

    var $elm1 = await __wx_find_elm(() =>
        document.getElementsByClassName("full-opr-wrp layout-row")[0]
    );
    if ($elm1) {
        // æ°´å¹³å¸ƒå±€æ’å…¥
        var relative_node = $elm1.children[$elm1.children.length - 1];
        $elm1.insertBefore(__wx_channels_video_download_btn__, relative_node);
        return;
    }
}
```

### 2. å¤šæ¨¡å¼ä¸‹è½½å®ç°

#### 2.1 åŠ å¯†è§†é¢‘ä¸‹è½½
```javascript
// ä»£ç ä½ç½®: inject/main.js:139-203
async function __wx_channels_download4(profile, opt) {
    var { filename, toMP3 } = opt;

    if (__wx_channels_config__.downloadLocalServerEnabled) {
        // ä½¿ç”¨æœ¬åœ°ä¸‹è½½æœåŠ¡å™¨
        var url = `http://${__wx_channels_config__.downloadLocalServerAddr}/download?url=${encodeURIComponent(profile.url)}&key=${profile.key}&filename=${encodeURIComponent(fullname)}&mp3=${Number(toMP3)}`;
        var a = document.createElement("a");
        a.href = url;
        a.download = fullname;
        document.body.appendChild(a);
        a.click();
        return;
    }

    // å‰ç«¯ä¸‹è½½æµç¨‹
    const response = await fetch(profile.url);
    const blob = await show_progress_or_loaded_size(response);

    // è§£å¯†å¤„ç†
    var array = new Uint8Array(await blob.arrayBuffer());
    if (profile.key) {
        const r = await __wx_channels_decrypt(profile.key);
        profile.decryptor_array = r;
        if (profile.decryptor_array) {
            array = __wx_channels_video_decrypt(array, 0, profile);
        }
    }

    // ä¿å­˜æ–‡ä»¶
    const result = new Blob([array], { type: "video/mp4" });
    saveAs(result, filename + ".mp4");
}
```

#### 2.2 å·²ç¼“å†²è§†é¢‘ä¸‹è½½
```javascript
// ä»£ç ä½ç½®: inject/main.js:78-84
async function __wx_channels_download(profile, filename) {
    const data = profile.data;  // ä»buffersè·å–
    const blob = new Blob(data, { type: "video/mp4" });
    await __wx_load_script("https://res.wx.qq.com/t/wx_fed/cdn_libs/res/FileSaver.min.js");
    saveAs(blob, filename + ".mp4");
}
```

### 3. æœ¬åœ°ä¸‹è½½æœåŠ¡å™¨

#### æœåŠ¡å™¨æ¶æ„è®¾è®¡
```go
// ä»£ç ä½ç½®: internal/download/download.go:87-101
type MediaProxyWithDecrypt struct {
    client *http.Client
}

func NewMediaProxyWithDecrypt() *MediaProxyWithDecrypt {
    tr := &http.Transport{
        TLSNextProto:        make(map[string]func(authority string, c *tls.Conn) http.RoundTripper),
        MaxIdleConns:        100,
        MaxIdleConnsPerHost: 10,
        IdleConnTimeout:     90 * time.Second,
    }
    return &MediaProxyWithDecrypt{
        client: &http.Client{Transport: tr},
    }
}
```

#### å®æ—¶è§£å¯†å¤„ç†
```go
// ä»£ç ä½ç½®: internal/download/download.go:20-57
type DecryptReader struct {
    reader   io.Reader
    ctx      *decrypt.RandCtx64
    limit    uint64
    consumed uint64
    ks       [8]byte      // å¯†é’¥æµç¼“å†²åŒº
    ksPos    int          // å¯†é’¥æµä½ç½®
}

func (dr *DecryptReader) Read(p []byte) (int, error) {
    n, err := dr.reader.Read(p)
    if n <= 0 || dr.limit == 0 || dr.consumed >= dr.limit {
        return n, err
    }

    toDecrypt := uint64(n)
    remaining := dr.limit - dr.consumed
    if toDecrypt > remaining {
        toDecrypt = remaining
    }

    // é€å­—èŠ‚å¼‚æˆ–è§£å¯†
    for i := uint64(0); i < toDecrypt; i++ {
        if dr.ksPos >= 8 {
            randNumber := dr.ctx.ISAacRandom()
            binary.BigEndian.PutUint64(dr.ks[:], randNumber)
            dr.ksPos = 0
        }
        p[i] ^= dr.ks[dr.ksPos]
        dr.ksPos++
    }

    dr.consumed += toDecrypt
    return n, err
}
```

---

## ğŸ”§ é€†å‘å·¥ç¨‹æŠ€æœ¯è·¯çº¿åˆ†æ

### 1. ç ”ç©¶å·¥å…·å¥—ä»¶

#### ç½‘ç»œæµé‡åˆ†æå±‚
```bash
# ä¸»è¦å·¥å…·é“¾
Charles Proxy / Fiddler           # HTTPSæµé‡æ‹¦æˆªå’Œè°ƒè¯•
Mitmproxy                        # å‘½ä»¤è¡Œçº§HTTP/HTTPSä»£ç†
Wireshark                        # åº•å±‚ç½‘ç»œåŒ…åˆ†æ
Chrome DevTools Network          # æµè§ˆå™¨çº§æµé‡ç›‘æ§
Burp Suite                       # Webåº”ç”¨å®‰å…¨æµ‹è¯•
```

#### JavaScripté€†å‘åˆ†æå±‚
```bash
# å‰ç«¯è°ƒè¯•å·¥å…·
Chrome DevTools Sources          # JavaScriptæ–­ç‚¹è°ƒè¯•
DevTools Performance             # å†…å­˜å’Œæ€§èƒ½åˆ†æ
DevTools Application             # å…¨å±€å˜é‡å’Œå­˜å‚¨ç›‘æ§
Firefox Debugger                 # è·¨æµè§ˆå™¨å…¼å®¹æ€§è°ƒè¯•
JavaScript Obfuscator            # ä»£ç æ··æ·†/è¿˜åŸå·¥å…·
Babel AST Explorer               # æŠ½è±¡è¯­æ³•æ ‘åˆ†æ
```

#### ç³»ç»Ÿçº§åˆ†æå·¥å…·
```bash
# æ·±åº¦åˆ†æ
Frida                            # åŠ¨æ€Hookæ¡†æ¶å’Œè„šæœ¬æ³¨å…¥
Ghidra / IDA Pro                 # äºŒè¿›åˆ¶ä»£ç åˆ†æ
x64dbg / OllyDbg                 # Windowså¹³å°è°ƒè¯•å™¨
LLDB / GDB                       *# Unixå¹³å°è°ƒè¯•å™¨
Process Monitor                  # Windowsç³»ç»Ÿè°ƒç”¨ç›‘æ§
DTrace / eBPF                    # Unixç³»ç»Ÿçº§è¿½è¸ª
```

### 2. ç ”ç©¶è·¯å¾„åˆ†æ

#### Phase 1: æµé‡æ¨¡å¼è¯†åˆ« (1-2å‘¨)

**å…³é”®å‘ç°ï¼š**
```javascript
// å‘ç°çš„æ ¸å¿ƒè·¯å¾„æ¨¡å¼
"/t/wx_fed/finder/web/web-finder/res/js/index.publish"     // è§†é¢‘æ’­æ”¾é€»è¾‘
"/t/wx_fed/finder/web/web-finder/res/js/virtual_svg-icons-register" // è§†é¢‘ä¿¡æ¯è·å–
"/connect.publish"                                           // è§†é¢‘æµæ§åˆ¶
"/web/pages/feed"                                           // è§†é¢‘è¯¦æƒ…é¡µ
"/web/pages/home"                                           // é¦–é¡µæµ
```

**æŠ€æœ¯æ–¹æ³•ï¼š**
1. **æµé‡æ‹¦æˆª**: ä½¿ç”¨Charles/Fiddleræ‹¦æˆªæ‰€æœ‰å¾®ä¿¡è§†é¢‘å·ç›¸å…³è¯·æ±‚
2. **URLæ¨¡å¼åˆ†æ**: é€šè¿‡æ­£åˆ™è¡¨è¾¾å¼è¯†åˆ«å…³é”®JavaScriptæ–‡ä»¶
3. **è¯·æ±‚æ—¶åºåˆ†æ**: ç»˜åˆ¶èµ„æºåŠ è½½ä¾èµ–å…³ç³»å›¾
4. **å“åº”å†…å®¹åˆ†æ**: è¯†åˆ«JavaScriptæ–‡ä»¶çš„åŠŸèƒ½å®šä½

#### Phase 2: JavaScripté™æ€åˆ†æ (2-3å‘¨)

**ä»£ç è¿˜åŸæŠ€æœ¯ï¼š**
```javascript
// å‹ç¼©ä»£ç ç¤ºä¾‹
!function(n){function t(t){for(var e,r,o=t[0],u=t[1],i=0,f=[];i<o.length;i++)r=o[i],a[r]&&f.push(a[r][0]),a[r]=0;for(e in u)Object.prototype.hasOwnProperty.call(u,e)&&(n[e]=u[e])}

// æ ¼å¼åŒ–å
!function(exports) {
    function t(module) {
        for(var dep, name, modules = module[0], factory = module[1], i = 0, cached = []; i < modules.length; i++) {
            name = modules[i];
            installedChunks[name] && cached.push(installedChunks[name][0]);
            installedChunks[name] = 0;
        }
        for(dep in factory) {
            Object.prototype.hasOwnProperty.call(factory, dep) && (exports[dep] = factory[dep]);
        }
    }
}
```

**å…³é”®å‡½æ•°è¯†åˆ«ï¼š**
```javascript
// å…³é”®æ­£åˆ™è¡¨è¾¾å¼åˆ†æ
jsSourceBufferReg = regexp.MustCompile(`this.sourceBuffer.appendBuffer\(([a-zA-Z]{1,})\)`)
jsAutoCutReg = regexp.MustCompile(`if\(f.cmd===re.MAIN_THREAD_CMD.AUTO_CUT`)
jsCommentDetailReg = regexp.MustCompile(`async finderGetCommentDetail\((\w+)\)\{(.*?)\}async`)
jsGoToNextFlowReg = regexp.MustCompile(`goToNextFlowFeed:([a-zA-Z]{1,})`)
jsGoToPrevFlowReg = regexp.MustCompile(`goToPrevFlowFeed:([a-zA-Z]{1,})`)
```

#### Phase 3: åŠ¨æ€è¡Œä¸ºç›‘æ§ (2-3å‘¨)

**è¿è¡Œæ—¶HookæŠ€æœ¯ï¼š**
```javascript
// MSEæ•°æ®æµç›‘æ§
(function() {
    const originalAppendBuffer = SourceBuffer.prototype.appendBuffer;
    SourceBuffer.prototype.appendBuffer = function(data) {
        console.log('Buffer intercepted:', data.byteLength);
        // ä¿å­˜æ•°æ®åˆ°å…¨å±€å˜é‡
        window.interceptedBuffers = window.interceptedBuffers || [];
        window.interceptedBuffers.push(data.slice(0));
        return originalAppendBuffer.call(this, data);
    };

    const originalUpdateEnd = SourceBuffer.prototype.onupdateend;
    SourceBuffer.prototype.onupdateend = function() {
        console.log('Buffer update completed');
        if(originalUpdateEnd) originalUpdateEnd.call(this);
    };
})();
```

**å†…å­˜ç›‘æ§è„šæœ¬ï¼š**
```javascript
// å…¨å±€å¯¹è±¡ç›‘æ§
(function() {
    const OriginalObject = window.Object;
    window.Object = new Proxy(OriginalObject, {
        defineProperty(target, property, descriptor) {
            if(property.includes('decrypt') || property.includes('key')) {
                console.log('Key-related property detected:', property, descriptor);
            }
            return OriginalObject.defineProperty(target, property, descriptor);
        }
    });
})();
```

#### Phase 4: åŠ å¯†æœºåˆ¶ç ´è§£ (3-4å‘¨)

**WASMæ¨¡å—åˆ†ææµç¨‹ï¼š**
```bash
# 1. WASMæ–‡ä»¶æå–
wget https://res.wx.qq.com/t/wx_fed/cdn_libs/res/decrypt-video-core/1.3.0/wasm_video_decode.wasm

# 2. åç¼–è¯‘åˆ†æ
wabt/wasm2c wasm_video_decode.wasm -o wasm_video_decode.c
ghidra --analyze wasm_video_decode.wasm

# 3. å‡½æ•°ç­¾åè¯†åˆ«
# æŸ¥æ‰¾ISAACç›¸å…³å‡½æ•°å’Œå¸¸é‡
```

**ç®—æ³•ç‰¹å¾è¯†åˆ«ï¼š**
```c
// ISAAC-64ç®—æ³•ç‰¹å¾
#define RANDSIZL   (8)    // log2 of RANDSIZ
#define RANDSIZ    (1<<RANDSIZL)  // 256

typedef struct isaac64_ctx {
    uint64_t randrsl[RANDSIZ];
    uint64_t randmem[RANDSIZ];
    uint64_t randa;
    uint64_t randb;
    uint64_t randc;
    uint64_t cnt;
} isaac64_ctx;
```

**å¯†é’¥æå–æ—¶æœºåˆ†æï¼š**
```javascript
// äº‹ä»¶ç›‘å¬å’Œæ—¶åºåˆ†æ
window.addEventListener('message', function(event) {
    if(event.data && event.data.type === 'VIDEO_SEGMENT_CHANGE') {
        console.log('Key exposure window detected:', event.data);
        // åœ¨è¿™ä¸ªæ—¶æœºç‚¹æå–å¯†é’¥
    }
});
```

### 3. å®éªŒéªŒè¯æ–¹æ³•

#### MSEæ•°æ®æµéªŒè¯
```javascript
// éªŒè¯MSEæ•°æ®å®Œæ•´æ€§
function validateMSEData(buffer) {
    // æ£€æŸ¥MP4æ–‡ä»¶å¤´
    const view = new DataView(buffer);
    const ftyp = String.fromCharCode(
        view.getUint8(4), view.getUint8(5), view.getUint8(6), view.getUint8(7)
    );

    if(ftyp === 'ftyp') {
        console.log('Valid MP4 file detected');
        return true;
    }
    return false;
}

// æ—¶é—´è½´éªŒè¯
function compareTimeline(original, decrypted) {
    // å¯¹æ¯”åŸå§‹å’Œè§£å¯†åçš„è§†é¢‘æ—¶é—´è½´
    const originalVideo = document.createElement('video');
    const decryptedVideo = document.createElement('video');

    originalVideo.src = URL.createObjectURL(new Blob([original]));
    decryptedVideo.src = URL.createObjectURL(new Blob([decrypted]));

    console.log('Original duration:', originalVideo.duration);
    console.log('Decrypted duration:', decryptedVideo.duration);
}
```

#### è§£å¯†ç®—æ³•éªŒè¯
```go
// å·²çŸ¥æ˜æ–‡æ”»å‡»éªŒè¯
func validateDecryption(encrypted, expected, key uint64) bool {
    decrypted := make([]byte, len(encrypted))
    copy(decrypted, encrypted)

    DecryptData(decrypted, uint32(len(decrypted)), key)

    // éªŒè¯è§£å¯†ç»“æœ
    return bytes.Contains(decrypted, expected)
}

// ç»Ÿè®¡æ¨¡å¼åˆ†æ
func analyzeEntropy(data []byte) float64 {
    freq := make(map[byte]int)
    for _, b := range data {
        freq[b]++
    }

    var entropy float64
    length := float64(len(data))
    for _, count := range freq {
        p := float64(count) / length
        if p > 0 {
            entropy -= p * math.Log2(p)
        }
    }

    return entropy
}
```

---

## ğŸ“ æ ¸å¿ƒæŠ€æœ¯æ´å¯Ÿæ€»ç»“

### 1. å…³é”®æŠ€æœ¯çªç ´ç‚¹

#### è®¾è®¡æ¨¡å¼è¯†åˆ«
- **MSEæ ‡å‡†æ¶æ„**: å¾®ä¿¡ä½¿ç”¨æ ‡å‡†çš„Media Source Extensionsè¿›è¡Œè§†é¢‘æ’­æ”¾
- **åˆ†æ®µåŠ å¯†æ¨¡å¼**: è§†é¢‘é‡‡ç”¨åˆ†æ®µä¼ è¾“å’ŒåŠ å¯†ï¼Œæ¯æ®µç‹¬ç«‹è§£å¯†
- **äº‹ä»¶é©±åŠ¨æ¶æ„**: é€šè¿‡è‡ªå®šä¹‰äº‹ä»¶åœ¨è§†é¢‘æ’­æ”¾å„é˜¶æ®µä¼ é€’ä¿¡æ¯

#### æ—¶åºæ”»å‡»åˆ©ç”¨
- **AUTO_CUTäº‹ä»¶çª—å£**: è§†é¢‘ç‰‡æ®µåˆ‡æ¢æ—¶å¯†é’¥åœ¨å†…å­˜ä¸­çŸ­æš‚å¯è§
- **appendBuffer Hook**: MSEæ•°æ®æ³¨å…¥æ˜¯æˆªè·åŸå§‹æ•°æ®çš„ç†æƒ³æ—¶æœº
- **finderGetCommentDetail**: ç»Ÿä¸€çš„è§†é¢‘ä¿¡æ¯è·å–å…¥å£ç‚¹

#### æ¶æ„å¤ç”¨ç­–ç•¥
- **å®˜æ–¹WASMæ¨¡å—**: ä½¿ç”¨å¾®ä¿¡å®˜æ–¹è§£å¯†ç»„ä»¶ç¡®ä¿å…¼å®¹æ€§
- **é€æ˜ä»£ç†æ¨¡å¼**: ä¸ç ´ååŸæœ‰æ’­æ”¾é€»è¾‘ï¼Œä»…åœ¨å…³é”®èŠ‚ç‚¹æ‹¦æˆª
- **æ¸è¿›å¼æ³¨å…¥**: é€æ­¥æ³¨å…¥åŠŸèƒ½ï¼Œç¡®ä¿ç³»ç»Ÿç¨³å®šæ€§

### 2. æŠ€æœ¯åˆ›æ–°ç‚¹

#### å¤šå±‚æ‹¦æˆªæ¶æ„
```
ç½‘ç»œå±‚ â†’ ä»£ç†æ‹¦æˆª â†’ æµé‡åˆ†æ
å‰ç«¯å±‚ â†’ JSæ³¨å…¥ â†’ å‡½æ•°Hook
åº”ç”¨å±‚ â†’ äº‹ä»¶ç›‘å¬ â†’ æ•°æ®æå–
ç®—æ³•å±‚ â†’ å¯†é’¥æˆªè· â†’ å®æ—¶è§£å¯†
```

#### å…¼å®¹æ€§ä¿è¯æœºåˆ¶
- **åŠŸèƒ½éš”ç¦»**: ä¸‹è½½åŠŸèƒ½å®Œå…¨ç‹¬ç«‹ï¼Œä¸å½±å“è§†é¢‘æ’­æ”¾
- **é™çº§æ”¯æŒ**: åœ¨æ— æ³•è§£å¯†æ—¶æä¾›åŸå§‹æ–‡ä»¶ä¸‹è½½
- **é”™è¯¯å¤„ç†**: å®Œå–„çš„å¼‚å¸¸å¤„ç†å’Œç”¨æˆ·æç¤º

#### ç”¨æˆ·ä½“éªŒä¼˜åŒ–
- **é€æ˜é›†æˆ**: ä¸‹è½½æŒ‰é’®æ— ç¼é›†æˆåˆ°åŸæœ‰ç•Œé¢
- **è¿›åº¦æ˜¾ç¤º**: å®æ—¶æ˜¾ç¤ºä¸‹è½½å’Œè§£å¯†è¿›åº¦
- **å¤šæ ¼å¼æ”¯æŒ**: æ”¯æŒä¸åŒåˆ†è¾¨ç‡å’ŒéŸ³é¢‘æå–

### 3. å®‰å…¨æ€§è€ƒé‡

#### æœ€å°æƒé™åŸåˆ™
- **åŸŸåé™åˆ¶**: ä»…æ‹¦æˆªå¾®ä¿¡è§†é¢‘å·ç›¸å…³åŸŸå
- **åŠŸèƒ½ä¸“ä¸€**: å·¥å…·ä¸“æ³¨äºè§†é¢‘ä¸‹è½½ï¼Œä¸æ¶‰åŠå…¶ä»–æ•æ„Ÿæ“ä½œ
- **æœ¬åœ°å¤„ç†**: æ‰€æœ‰è§£å¯†æ“ä½œåœ¨æœ¬åœ°å®Œæˆï¼Œä¸æ¶‰åŠæ•°æ®å¤–ä¼ 

#### åˆè§„æ€§è®¾è®¡
- **ä¸ªäººä½¿ç”¨**: æ˜ç¡®å®šä½ä¸ºä¸ªäººå­¦ä¹ å’Œç ”ç©¶å·¥å…·
- **ç‰ˆæƒå£°æ˜**: å¼ºè°ƒéµå®ˆç‰ˆæƒæ³•å¾‹æ³•è§„
- **æŠ€æœ¯æ–‡æ¡£**: è¯¦ç»†çš„æŠ€æœ¯åŸç†è¯´æ˜ï¼Œä¾¿äºå®¡æŸ¥

---

## ğŸ”® æŠ€æœ¯å‘å±•è¶‹åŠ¿å±•æœ›

### 1. å‰ç«¯æŠ€æœ¯æ¼”è¿›å½±å“

#### MSEæŠ€æœ¯æ ‡å‡†åŒ–
- **MediaSource 2.0**: æ–°çš„MSEæ ‡å‡†æä¾›æ›´å¤šæ§åˆ¶æ¥å£
- **WebCodecs API**: ç›´æ¥è®¿é—®ç¼–è§£ç å™¨ï¼Œå¯èƒ½æ”¹å˜è§†é¢‘å¤„ç†æ–¹å¼
- **WebAssembly 2.0**: æ›´å¼ºçš„WASMæ€§èƒ½å’Œè°ƒè¯•èƒ½åŠ›

#### åŠ å¯†ç®—æ³•å‡çº§
- **åé‡å­å¯†ç **: å¾®ä¿¡å¯èƒ½é‡‡ç”¨æŠ—é‡å­æ”»å‡»çš„åŠ å¯†ç®—æ³•
- **ç¡¬ä»¶åŠ å¯†**: åˆ©ç”¨ç¡¬ä»¶TPMè¿›è¡Œå¯†é’¥ä¿æŠ¤
- **åŠ¨æ€å¯†é’¥**: å®æ—¶å˜åŒ–çš„å¯†é’¥ç­–ç•¥

### 2. é€†å‘å·¥ç¨‹å·¥å…·å‘å±•

#### è‡ªåŠ¨åŒ–åˆ†æå·¥å…·
- **AIè¾…åŠ©åæ··æ·†**: ä½¿ç”¨æœºå™¨å­¦ä¹ è¯†åˆ«æ··æ·†æ¨¡å¼
- **åŠ¨æ€åˆ†æå¹³å°**: è‡ªåŠ¨åŒ–çš„è¡Œä¸ºåˆ†æå’Œç›‘æ§
- **è·¨å¹³å°è°ƒè¯•**: ç»Ÿä¸€çš„è°ƒè¯•å’Œåˆ†æç¯å¢ƒ

#### åˆæ³•åŒ–å·¥å…·ç”Ÿæ€
- **å‚å•†API**: å®˜æ–¹æä¾›çš„å¼€å‘å’Œè°ƒè¯•æ¥å£
- **æ²™ç›’ç¯å¢ƒ**: å®‰å…¨çš„åº”ç”¨åˆ†æç¯å¢ƒ
- **åˆè§„æ¡†æ¶**: æ˜ç¡®çš„åˆæ³•ç ”ç©¶è¾¹ç•Œ

### 3. æŠ€æœ¯ä¼¦ç†è€ƒé‡

#### çŸ¥è¯†äº§æƒä¿æŠ¤
- **æŠ€æœ¯é€æ˜åº¦**: å¹³å°æŠ€æœ¯çš„å¼€æ”¾ç¨‹åº¦
- **åˆç†ä½¿ç”¨**: ç”¨æˆ·æƒåˆ©çš„å¹³è¡¡
- **æŠ€æœ¯åˆ›æ–°**: æ­£å‘æŠ€æœ¯æ¿€åŠ±

#### éšç§å’Œå®‰å…¨
- **æ•°æ®ä¿æŠ¤**: ç”¨æˆ·æ•°æ®çš„å®‰å…¨å¤„ç†
- **ç³»ç»Ÿå®‰å…¨**: é€†å‘å·¥å…·çš„å®‰å…¨å½±å“
- **æ³•å¾‹åˆè§„**: æŠ€æœ¯ä½¿ç”¨çš„æ³•å¾‹è¾¹ç•Œ

---

## ğŸ“š å‚è€ƒèµ„æºå’Œè‡´è°¢

### å¼€æºé¡¹ç›®å¼•ç”¨
- **å‰ç«¯è§£å¯†å‚è€ƒ**: https://github.com/kanadeblisst00/WechatVideoSniffer2.0
- **åç«¯è§£å¯†ä»£ç **: https://github.com/Hanson/WechatSphDecrypt

### æŠ€æœ¯æ–‡æ¡£
- **Media Source Extensions**: https://developer.mozilla.org/en-US/docs/Web/API/Media_Source_Extensions_API
- **ISAACåŠ å¯†ç®—æ³•**: https://en.wikipedia.org/wiki/ISAAC_(cipher)
- **WebAssemblyè§„èŒƒ**: https://webassembly.github.io/spec/

### å·¥å…·èµ„æº
- **Chrome DevTools**: https://developer.chrome.com/docs/devtools/
- **Charles Proxy**: https://www.charlesproxy.com/
- **Fiddler**: https://www.telerik.com/fiddler

---

## ğŸ“„ å…è´£å£°æ˜

æœ¬æŠ€æœ¯åˆ†ææŠ¥å‘Šä»…ç”¨äºå­¦æœ¯ç ”ç©¶å’ŒæŠ€æœ¯äº¤æµç›®çš„ã€‚æ‰€æœ‰åˆ†æéƒ½åŸºäºå¼€æºä»£ç å’Œå…¬å¼€å¯ç”¨çš„æŠ€æœ¯ä¿¡æ¯ã€‚

**é‡è¦æé†’ï¼š**
- æœ¬é¡¹ç›®ä¸ºå¼€æºé¡¹ç›®ï¼Œä»…ç”¨äºæŠ€æœ¯äº¤æµå­¦ä¹ å’Œç ”ç©¶
- è¯·éµå®ˆç›¸å…³æ³•å¾‹æ³•è§„ï¼Œå‹¿ç”¨ä½œä»»ä½•éæ³•ç”¨é€”
- ä½¿ç”¨æœ¬é¡¹ç›®ä¸‹è½½çš„å†…å®¹è¯·éµå®ˆç‰ˆæƒæ³•å¾‹æ³•è§„
- ä»»ä½•å› ä½¿ç”¨æœ¬é¡¹ç›®é€ æˆçš„æ³•å¾‹åæœç”±ä½¿ç”¨è€…è‡ªè¡Œæ‰¿æ‹…

**æŠ€æœ¯ä¼¦ç†å£°æ˜ï¼š**
æœ¬æŠ¥å‘Šå€¡å¯¼è´Ÿè´£ä»»çš„æŠ€æœ¯ç ”ç©¶ï¼š
- å°Šé‡çŸ¥è¯†äº§æƒå’Œå¹³å°è§„åˆ™
- éµå®ˆç½‘ç»œå®‰å…¨å’Œæ•°æ®ä¿æŠ¤æ³•è§„
- åšæŒæŠ€æœ¯å‘å–„ï¼Œä¿ƒè¿›æŠ€æœ¯å¥åº·å‘å±•
- åå¯¹æ¶æ„åˆ©ç”¨å’ŒæŠ€æœ¯æ»¥ç”¨

---

*æŠ¥å‘Šç”Ÿæˆæ—¶é—´ï¼š2025å¹´12æœˆ9æ—¥*
*æŠ€æœ¯åˆ†æç‰ˆæœ¬ï¼šåŸºäºé¡¹ç›®ç‰ˆæœ¬ 251202*
*åˆ†ææ·±åº¦ï¼šå®Œæ•´æºç çº§åˆ«çš„æŠ€æœ¯è§£æ*